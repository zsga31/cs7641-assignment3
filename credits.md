Based on Chad Maron's code.
